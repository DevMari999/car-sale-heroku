<%- include('partials/header'); -%>
<div class="all-cars">
    <div class="car">

        <h2><%= car.brand %></h2>
        <h2><%= car.model %></h2>
        <p><b>Price:</b> <%= car.price %> <%= car.currency %></p>
        <p><b>Year:</b> <%= car.year %></p>
        <p><b>Where:</b> <%= car.region %></p>
        <p><b>Description:</b> <%= car.description %></p>
        <p><b>Posted by:</b> <%= usersMap.get(car.created_by.toString()).username %></p>

        <% if (user && (user.role === "manager" || user.role === "administrator" || user._id.equals(car.created_by._id))) { %>
            <div>--------------------</div>
            <h3>Statistics:</h3>
            <p>Total Views: <%= totalViews %></p>
            <p>Views in the Past Week: <%= pastWeekViews %></p>
            <p>Views in the Past Month: <%= pastMonthViews %></p>
            <p>Average Price by All: <%= averagePriceByAll.toFixed(2) %></p>
            <p>Average Price by Region: <%= averagePriceByRegion.toFixed(2) %></p>

            <button id="deleteButton">Delete</button>
        <% } %>
        <button id="contact">Contact</button>
    </div>

</div>

<%- include('partials/footer'); -%>

<script>
    document.getElementById("deleteButton").addEventListener("click", function () {
        if (confirm("Are you sure you want to delete this car?")) {
            fetch(`/cars/<%= car._id %>`, {
                method: "DELETE",
            })
                .then(response => {
                    if (response.ok) {
                        console.log("Car deleted successfully");
                        return response.text();
                    } else {
                        console.error("Failed to delete car");
                    }
                })
                .then(() => {
                    window.location.href = "/";
                })
                .catch(error => {
                    console.error("Error:", error);
                });
        }
    });

</script>

